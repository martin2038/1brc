
## 1. create file , 12/3GB

```bash
jbang src/main/java/dev/morling/onebrc/CreateMeasurementsFast.java 1000000000
jbang src/main/java/dev/morling/onebrc/CreateMeasurements3.java 1000000000
Created file with 1,000,000,000 measurements in 22335 ms

ls -lah measurements.txt
-rw-r--r--  1 martin  staff    13G Jan 30 12:00 measurements.txt
```

## 2. baseline

```bash
jbang src/main/java/dev/morling/onebrc/CalculateAverage_baseline.java
jbang src/main/java/dev/morling/onebrc/CalculateAverage_martin2038.java
```

```txt
cost : 187843 ms
{Abha=-32.2/18.0/68.8, Abidjan=-28.0/26.0/72.7, Abéché=-19.2/29.4/77.5, Accra=-21.2/26.4/78.8, Addis Ababa=-33.9/16.0/68.8, Adelaide=-37.7/17.3/69.6, Aden=-20.5/29.1/80.0, Ahvaz=-25.0/25.4/75.3, Albuquerque=-36.7/14.0/62.9, Alexandra=-41.5/11.0/58.0, Alexandria=-28.7/20.0/71.4, Algiers=-33.2/18.2/69.4, Alice Springs=-30.3/21.0/71.4, Almaty=-37.7/10.0/62.1, Amsterdam=-38.7/10.2/64.3, Anadyr=-55.5/-6.9/45.7, Anchorage=-47.3/2.8/50.3, Andorra la Vella=-39.8/9.8/61.0, Ankara=-34.4/12.0/61.8, Antananarivo=-31.1/17.9/67.4, Antsiranana=-26.1/25.2/74.7, Arkhangelsk=-50.7/1.3/51.9, Ashgabat=-32.2/17.1/67.7, Asmara=-35.3/15.6/64.6, Assab=-19.7/30.5/82.1, Astana=-43.9/3.5/56.2, Athens=-28.2/19.2/68.5, Atlanta=-33.4/17.0/74.4, Auckland=-35.4/15.2/64.3, Austin=-30.5/20.7/76.8, Baghdad=-25.8/22.8/75.0, Baguio=-27.4/19.5/70.2, Baku=-33.7/15.1/66.1, Baltimore=-37.6/13.1/63.2, Bamako=-23.3/27.8/76.0, Bangkok=-18.8/28.6/83.3, Bangui=-26.2/26.0/77.6, Banjul=-25.3/26.0/74.2, Barcelona=-31.0/18.2/71.5, Bata=-25.5/25.1/76.1, Batumi=-35.0/14.0/61.2, Beijing=-39.0/12.9/61.9, Beirut=-28.9/20.9/68.3, Belgrade=-36.4/12.5/61.4, Belize City=-20.2/26.7/78.3, Benghazi=-32.8/19.9/68.7, Bergen=-45.9/7.7/56.8, Berlin=-36.6/10.3/58.3, Bilbao=-39.1/14.7/64.9, Birao=-23.8/26.5/81.9, Bishkek=-37.1/11.3/60.5, Bissau=-29.1/27.0/74.7, Blantyre=-28.8/22.2/69.9, Bloemfontein=-35.1/15.6/77.2, Boise=-38.6/11.4/60.4, Bordeaux=-35.5/14.2/62.3, Bosaso=-21.4/30.0/84.1, Boston=-35.6/10.9/62.7, Bouaké=-22.4/26.0/72.8, Bratislava=-42.2/10.5/59.6, Brazzaville=-27.0/25.0/73.8, Bridgetown=-22.8/27.0/74.0, Brisbane=-28.6/21.4/75.2, Brussels=-40.9/10.5/62.8, Bucharest=-39.9/10.8/60.8, Budapest=-37.1/11.3/63.9, Bujumbura=-29.2/23.8/74.0, Bulawayo=-34.1/18.9/78.8, Burnie=-36.6/13.1/60.1, Busan=-35.4/15.0/62.6, Cabo San Lucas=-25.3/23.9/76.2, Cairns=-24.1/25.0/77.8, Cairo=-27.0/21.4/70.3, Calgary=-46.9/4.4/54.5, Canberra=-36.9/13.1/62.6, Cape Town=-33.2/16.2/66.7, Changsha=-34.1/17.4/68.9, Charlotte=-35.8/16.1/62.2, Chiang Mai=-22.6/25.8/79.8, Chicago=-39.4/9.8/61.3, Chihuahua=-36.2/18.6/68.0, Chittagong=-25.8/25.9/79.4, Chișinău=-40.4/10.2/63.0, Chongqing=-30.4/18.6/75.0, Christchurch=-37.8/12.2/60.9, City of San Marino=-39.2/11.8/65.0, Colombo=-21.9/27.4/82.7, Columbus=-36.8/11.7/57.7, Conakry=-19.9/26.4/76.4, Copenhagen=-43.2/9.1/59.5, Cotonou=-25.8/27.2/76.4, Cracow=-45.9/9.3/65.3, Da Lat=-29.5/17.9/70.0, Da Nang=-27.1/25.8/72.9, Dakar=-26.2/24.0/72.8, Dallas=-31.0/19.0/70.2, Damascus=-31.4/17.0/65.9, Dampier=-23.7/26.4/76.2, Dar es Salaam=-24.5/25.8/76.4, Darwin=-26.5/27.6/78.4, Denpasar=-27.5/23.7/77.9, Denver=-39.1/10.4/63.2, Detroit=-40.1/10.0/64.6, Dhaka=-22.2/25.9/78.9, Dikson=-60.9/-11.1/38.8, Dili=-22.7/26.6/76.9, Djibouti=-17.2/29.9/79.5, Dodoma=-27.7/22.7/76.4, Dolisie=-24.6/24.0/74.9, Douala=-23.6/26.7/76.4, Dubai=-20.9/26.9/76.5, Dublin=-45.8/9.8/61.0, Dunedin=-36.5/11.1/61.0, Durban=-30.2/20.6/75.3, Dushanbe=-33.7/14.7/63.6, Edinburgh=-41.6/9.3/59.9, Edmonton=-45.5/4.2/54.2, El Paso=-34.4/18.1/67.6, Entebbe=-25.8/21.0/70.6, Erbil=-29.8/19.5/67.3, Erzurum=-42.6/5.1/52.4, Fairbanks=-51.0/-2.3/47.3, Fianarantsoa=-33.2/17.9/67.0, Flores,  Petén=-22.7/26.4/80.2, Frankfurt=-39.9/10.6/60.7, Fresno=-29.7/17.9/65.4, Fukuoka=-38.0/17.0/68.2, Gaborone=-29.7/21.0/69.2, Gabès=-32.4/19.5/68.0, Gagnoa=-23.4/26.0/74.5, Gangtok=-35.1/15.2/66.9, Garissa=-20.1/29.3/77.5, Garoua=-18.8/28.3/81.2, George Town=-20.5/27.9/85.4, Ghanzi=-27.5/21.4/70.0, Gjoa Haven=-63.1/-14.4/39.0, Guadalajara=-26.5/20.9/67.7, Guangzhou=-29.5/22.4/70.2, Guatemala City=-27.9/20.4/72.2, Halifax=-44.2/7.5/58.3, Hamburg=-40.0/9.7/57.8, Hamilton=-34.3/13.8/67.0, Hanga Roa=-26.7/20.5/72.9, Hanoi=-33.3/23.6/71.7, Harare=-30.7/18.4/66.2, Harbin=-46.0/5.0/52.8, Hargeisa=-31.7/21.7/73.5, Hat Yai=-23.3/27.0/74.3, Havana=-23.3/25.2/70.9, Helsinki=-42.1/5.9/54.3, Heraklion=-31.9/18.9/70.6, Hiroshima=-35.1/16.3/66.2, Ho Chi Minh City=-20.8/27.4/77.8, Hobart=-37.2/12.7/63.0, Hong Kong=-30.9/23.3/70.9, Honiara=-26.0/26.5/74.6, Honolulu=-21.6/25.4/78.9, Houston=-27.2/20.8/72.6, Ifrane=-39.1/11.4/65.8, Indianapolis=-36.7/11.8/59.6, Iqaluit=-59.7/-9.3/37.4, Irkutsk=-47.7/1.0/55.6, Istanbul=-35.9/13.9/63.1, Jacksonville=-30.8/20.3/74.2, Jakarta=-23.6/26.7/78.2, Jayapura=-23.0/27.0/77.3, Jerusalem=-36.7/18.3/71.4, Johannesburg=-34.7/15.5/64.3, Jos=-26.1/22.8/73.4, Juba=-24.5/27.8/79.3, Kabul=-35.9/12.1/65.7, Kampala=-27.6/20.0/75.1, Kandi=-21.1/27.7/76.8, Kankan=-22.4/26.5/76.1, Kano=-23.1/26.4/80.5, Kansas City=-39.5/12.5/63.6, Karachi=-26.5/26.0/77.7, Karonga=-22.6/24.4/74.7, Kathmandu=-33.5/18.3/69.1, Khartoum=-22.4/29.9/77.0, Kingston=-21.7/27.4/75.2, Kinshasa=-25.3/25.3/74.3, Kolkata=-25.0/26.7/74.0, Kuala Lumpur=-22.7/27.3/74.3, Kumasi=-22.5/26.0/74.5, Kunming=-35.7/15.7/72.6, Kuopio=-46.2/3.4/56.6, Kuwait City=-22.5/25.7/76.5, Kyiv=-44.6/8.4/58.3, Kyoto=-33.1/15.8/66.5, La Ceiba=-30.0/26.2/74.2, La Paz=-24.7/23.7/75.8, Lagos=-24.8/26.8/76.4, Lahore=-28.9/24.3/76.6, Lake Havasu City=-26.4/23.7/73.8, Lake Tekapo=-41.7/8.7/60.5, Las Palmas de Gran Canaria=-29.9/21.2/70.1, Las Vegas=-30.9/20.3/69.6, Launceston=-37.5/13.1/60.8, Lhasa=-41.2/7.6/57.9, Libreville=-24.2/25.9/73.7, Lisbon=-37.6/17.5/70.9, Livingstone=-25.8/21.8/72.7, Ljubljana=-39.2/10.9/58.7, Lodwar=-20.6/29.3/77.7, Lomé=-25.6/26.9/75.6, London=-37.9/11.3/59.4, Los Angeles=-30.1/18.6/67.6, Louisville=-37.9/13.9/69.0, Luanda=-21.8/25.8/73.8, Lubumbashi=-29.7/20.8/72.2, Lusaka=-36.9/19.9/68.7, Luxembourg City=-41.3/9.3/62.0, Lviv=-43.7/7.8/56.0, Lyon=-39.8/12.5/60.9, Madrid=-36.7/15.0/64.1, Mahajanga=-24.6/26.3/77.1, Makassar=-21.9/26.7/79.0, Makurdi=-24.9/26.0/78.9, Malabo=-24.7/26.3/75.5, Malé=-24.4/28.0/77.8, Managua=-23.4/27.3/79.1, Manama=-24.7/26.5/75.7, Mandalay=-19.4/28.0/76.4, Mango=-25.7/28.1/79.6, Manila=-19.1/28.4/77.1, Maputo=-27.7/22.8/71.6, Marrakesh=-31.1/19.6/70.6, Marseille=-40.8/15.8/66.1, Maun=-24.7/22.4/73.6, Medan=-21.5/26.5/77.6, Mek'ele=-26.0/22.7/73.5, Melbourne=-32.6/15.1/64.0, Memphis=-30.2/17.2/67.1, Mexicali=-27.7/23.1/80.5, Mexico City=-32.3/17.5/71.9, Miami=-20.7/24.9/72.9, Milan=-37.6/13.0/65.2, Milwaukee=-41.4/8.9/56.4, Minneapolis=-44.1/7.8/63.4, Minsk=-42.7/6.7/56.6, Mogadishu=-29.1/27.1/77.4, Mombasa=-27.8/26.3/80.3, Monaco=-29.5/16.4/67.4, Moncton=-43.1/6.1/55.0, Monterrey=-29.2/22.3/73.8, Montreal=-41.6/6.8/53.9, Moscow=-43.3/5.8/53.7, Mumbai=-23.3/27.1/84.6, Murmansk=-50.6/0.6/55.8, Muscat=-27.1/28.0/81.4, Mzuzu=-32.3/17.7/68.6, N'Djamena=-20.4/28.3/79.9, Naha=-26.0/23.1/72.8, Nairobi=-31.7/17.8/68.8, Nakhon Ratchasima=-23.4/27.3/77.9, Napier=-35.0/14.6/66.3, Napoli=-31.9/15.9/67.2, Nashville=-35.2/15.4/68.9, Nassau=-32.8/24.6/74.7, Ndola=-29.2/20.3/74.5, New Delhi=-23.5/25.0/77.1, New Orleans=-29.8/20.7/67.8, New York City=-34.0/12.9/63.9, Ngaoundéré=-24.8/22.0/76.2, Niamey=-19.1/29.3/79.6, Nicosia=-32.3/19.7/71.6, Niigata=-36.1/13.9/65.4, Nouadhibou=-24.9/21.3/70.2, Nouakchott=-24.3/25.7/74.1, Novosibirsk=-48.6/1.7/50.9, Nuuk=-55.3/-1.4/49.5, Odesa=-41.9/10.7/59.2, Odienné=-29.9/26.0/74.4, Oklahoma City=-32.3/15.9/67.8, Omaha=-37.4/10.6/60.7, Oranjestad=-22.3/28.1/77.4, Oslo=-42.5/5.7/57.4, Ottawa=-44.6/6.6/57.8, Ouagadougou=-21.2/28.3/81.8, Ouahigouya=-19.7/28.6/77.6, Ouarzazate=-28.8/18.9/67.7, Oulu=-50.9/2.7/49.1, Palembang=-21.2/27.3/76.7, Palermo=-30.2/18.5/71.2, Palm Springs=-25.7/24.5/74.3, Palmerston North=-36.5/13.2/60.9, Panama City=-24.3/28.0/76.6, Parakou=-25.7/26.8/75.9, Paris=-37.9/12.3/59.2, Perth=-30.5/18.7/66.5, Petropavlovsk-Kamchatsky=-46.0/1.9/50.0, Philadelphia=-39.3/13.2/64.5, Phnom Penh=-24.6/28.3/79.9, Phoenix=-29.3/23.9/74.0, Pittsburgh=-39.5/10.8/59.5, Podgorica=-37.7/15.3/67.6, Pointe-Noire=-26.3/26.1/78.1, Pontianak=-24.1/27.7/79.2, Port Moresby=-24.8/26.9/79.8, Port Sudan=-29.5/28.4/84.5, Port Vila=-27.0/24.3/76.6, Port-Gentil=-22.7/26.0/76.2, Portland (OR)=-36.1/12.4/62.2, Porto=-35.0/15.7/64.8, Prague=-39.7/8.4/56.5, Praia=-22.9/24.4/76.9, Pretoria=-29.1/18.2/66.6, Pyongyang=-38.2/10.8/66.3, Rabat=-33.2/17.2/65.3, Rangpur=-26.1/24.4/71.0, Reggane=-19.6/28.3/75.2, Reykjavík=-45.8/4.3/55.4, Riga=-42.8/6.2/55.7, Riyadh=-26.0/26.0/78.1, Rome=-39.2/15.2/63.0, Roseau=-22.1/26.2/73.9, Rostov-on-Don=-39.7/9.9/59.1, Sacramento=-33.8/16.3/66.4, Saint Petersburg=-53.1/5.8/54.9, Saint-Pierre=-43.1/5.7/57.4, Salt Lake City=-37.3/11.6/59.8, San Antonio=-31.4/20.8/68.3, San Diego=-30.2/17.8/67.7, San Francisco=-34.8/14.6/60.7, San Jose=-31.6/16.4/64.2, San José=-25.1/22.6/72.3, San Juan=-25.0/27.2/73.6, San Salvador=-26.0/23.1/75.0, Sana'a=-29.4/20.0/69.7, Santo Domingo=-24.7/25.9/76.9, Sapporo=-39.1/8.9/60.4, Sarajevo=-39.4/10.1/59.6, Saskatoon=-53.0/3.3/53.6, Seattle=-37.5/11.3/61.3, Seoul=-38.1/12.5/63.3, Seville=-31.3/19.2/67.5, Shanghai=-33.2/16.7/65.7, Singapore=-24.9/27.0/80.4, Skopje=-35.7/12.4/59.7, Sochi=-37.1/14.2/65.6, Sofia=-40.2/10.6/63.3, Sokoto=-22.6/28.0/73.5, Split=-34.7/16.1/65.4, St. John's=-42.6/5.0/54.7, St. Louis=-36.9/13.9/59.7, Stockholm=-44.1/6.6/58.6, Surabaya=-22.3/27.1/78.2, Suva=-24.6/25.6/75.2, Suwałki=-40.8/7.2/55.8, Sydney=-39.7/17.7/66.5, Ségou=-22.0/28.0/74.7, Tabora=-29.1/23.0/76.1, Tabriz=-34.6/12.6/62.2, Taipei=-24.9/23.0/72.8, Tallinn=-45.1/6.4/53.3, Tamale=-22.1/27.9/79.7, Tamanrasset=-27.5/21.7/74.4, Tampa=-24.6/22.9/69.7, Tashkent=-34.0/14.8/70.1, Tauranga=-34.6/14.8/63.7, Tbilisi=-37.7/12.9/62.2, Tegucigalpa=-28.2/21.7/72.1, Tehran=-33.4/17.0/67.6, Tel Aviv=-30.2/20.0/72.0, Thessaloniki=-37.6/16.0/64.6, Thiès=-24.4/24.0/72.9, Tijuana=-31.1/17.8/66.8, Timbuktu=-21.6/28.0/78.8, Tirana=-41.7/15.2/67.3, Toamasina=-29.7/23.4/71.9, Tokyo=-35.9/15.4/64.7, Toliara=-28.0/24.1/73.7, Toluca=-37.5/12.4/61.1, Toronto=-36.8/9.4/58.6, Tripoli=-29.5/20.0/67.8, Tromsø=-43.3/2.9/52.2, Tucson=-28.9/20.9/69.2, Tunis=-30.6/18.4/67.3, Ulaanbaatar=-48.1/-0.4/49.7, Upington=-25.7/20.4/79.1, Vaduz=-39.2/10.1/58.7, Valencia=-34.5/18.3/71.7, Valletta=-30.7/18.8/65.9, Vancouver=-38.1/10.4/61.2, Veracruz=-23.9/25.4/75.4, Vienna=-37.7/10.4/60.1, Vientiane=-31.3/25.9/76.5, Villahermosa=-23.7/27.1/79.6, Vilnius=-44.1/6.0/53.5, Virginia Beach=-37.7/15.8/66.6, Vladivostok=-44.2/4.9/53.9, Warsaw=-40.2/8.5/60.9, Washington, D.C.=-41.7/14.6/64.8, Wau=-21.2/27.8/77.7, Wellington=-36.8/12.9/66.1, Whitehorse=-49.2/-0.1/51.1, Wichita=-35.1/13.9/63.2, Willemstad=-23.6/28.0/76.0, Winnipeg=-44.5/3.0/52.6, Wrocław=-42.6/9.6/59.0, Xi'an=-35.4/14.1/63.8, Yakutsk=-57.6/-8.8/39.7, Yangon=-20.9/27.5/81.0, Yaoundé=-26.5/23.8/73.9, Yellowknife=-53.8/-4.3/43.4, Yerevan=-37.4/12.4/63.6, Yinchuan=-41.1/9.0/59.3, Zagreb=-40.6/10.7/59.6, Zanzibar City=-26.3/26.0/80.0, Zürich=-42.1/9.3/59.0, Ürümqi=-44.0/7.4/57.6, İzmir=-32.0/17.9/70.5}
670230376
```

## profile

```bash
jbang --javaagent=ap-loader@jvm-profiling-tools/ap-loader=start,event=cpu,file=profile.html  src/main/java/dev/morling/onebrc/CalculateAverage_martin2038.java


export JAVA_TOOL_OPTIONS="-Dhttp.proxyHost=127.0.0.1 -Dhttp.proxyPort=1088 -Dhttps.proxyHost=127.0.0.1 -Dhttps.proxyPort=1088"


```

##  持续优化

```bash
hyperfine --warmup 2 --runs 10 'jbang src/main/java/dev/morling/onebrc/CalculateAverage_martin2038.java'
```

```sh
# use string 
Benchmark 1: jbang src/main/java/dev/morling/onebrc/CalculateAverage_martin2038.java 
  Time (mean ± σ):      5.756 s ±  0.121 s    [User: 46.685 s, System: 1.443 s]
  Range (min … max):    5.519 s …  5.957 s    10 runs

# use calculateHash
Benchmark 1: jbang src/main/java/dev/morling/onebrc/CalculateAverage_martin2038.java 
  Time (mean ± σ):      5.253 s ±  0.128 s    [User: 42.004 s, System: 1.453 s]
  Range (min … max):    5.076 s …  5.482 s    10 runs

# use FNV1a , save about 100ms
Benchmark 1: jbang src/main/java/dev/morling/onebrc/CalculateAverage_martin2038.java 
  Time (mean ± σ):      5.159 s ±  0.176 s    [User: 41.492 s, System: 1.431 s]
  Range (min … max):    4.976 s …  5.543 s    10 runs 
```